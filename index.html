<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster: Your Life Gamified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/duration.js"></script>
    <!-- Sound Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_relativeTime);
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_duration);
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-primary': '#1a1a1a',
                        'brand-secondary': '#2c2c2c',
                        'brand-accent': '#4f46e5',
                        'brand-accent-hover': '#4338ca',
                        'brand-text': '#f5f5f5',
                        'brand-subtle': '#a3a3a3',
                        'brand-success': '#22c55e',
                        'brand-warning': '#facc15',
                        'brand-danger': '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #1a1a1a; color: #f5f5f5; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
        .task-card { background: linear-gradient(145deg, #2e2e2e, #262626); box-shadow: 8px 8px 16px #1e1e1e, -8px -8px 16px #343434; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tab-active { border-bottom-color: #4f46e5; color: #f5f5f5; }
        .tab { border-bottom-color: transparent; color: #a3a3a3; }
        #compliance-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl font-sans">
        
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <img id="compliance-avatar" src="1.png" alt="Compliance Status" class="h-10 w-10 md:h-12 md:w-12 rounded border-2 border-gray-600 object-cover" onerror="this.src='https://placehold.co/48x48/2c2c2c/a3a3a3?text=Err'">
                <h1 class="text-3xl md:text-4xl font-bold text-brand-text">TaskMaster</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div id="streak-display" class="text-right"></div>
                <div id="points-debt-display" class="text-right"> 
                    <p class="text-brand-subtle text-sm">Points</p>
                    <p id="points-display" class="text-2xl font-bold text-brand-accent">0</p>
                </div>
                <button id="shop-btn" class="btn bg-brand-secondary p-3 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </button>
            </div>
        </header>

        <main id="main-content" class="text-center p-8 rounded-2xl task-card min-h-[300px] flex flex-col justify-center items-center"></main>

        <div id="compliance-container" class="mt-8">
            <div class="w-full bg-brand-danger rounded-full h-6 border-2 border-gray-600 relative overflow-hidden">
                <div id="compliance-bar" class="bg-brand-success h-full rounded-full"></div>
                <div id="compliance-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.7);"></div>
            </div>
        </div>

        <footer class="mt-4 flex justify-center">
            <button id="manage-btn" class="btn bg-brand-secondary hover:bg-gray-700 text-brand-text font-bold py-3 px-6 rounded-lg shadow-lg">Manage Your Setup</button>
        </footer>

    </div>

    <!-- Modals (structure unchanged) -->
    <div id="sound-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-sm text-center p-8"><h2 class="text-2xl font-bold mb-4">Enable Sound</h2><p class="text-brand-subtle mb-6">Click the button below to enable sound notifications for new tasks.</p><button id="enable-sound-btn" class="btn w-full bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-6 rounded-lg">Enable Sound</button></div></div>
    <div id="manage-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">Manage Your Setup</h2><button class="close-modal-btn text-gray-400 hover:text-white" data-modal="manage-modal">&times;</button></div><div class="flex border-b border-gray-700 px-6 overflow-x-auto"><button data-tab="tasks" class="tab tab-active text-lg font-semibold py-4 mr-6 flex-shrink-0">Tasks</button><button data-tab="rewards" class="tab text-lg font-semibold py-4 mr-6 flex-shrink-0">Rewards</button><button data-tab="forfeits" class="tab text-lg font-semibold py-4 mr-6 flex-shrink-0">Forfeits</button><button data-tab="schedule" class="tab text-lg font-semibold py-4 mr-6 flex-shrink-0">Schedule</button><button data-tab="settings" class="tab text-lg font-semibold py-4 flex-shrink-0">Settings</button></div><div class="p-6 overflow-y-auto"><div id="tasks-tab" class="tab-content"></div><div id="rewards-tab" class="tab-content hidden"></div><div id="forfeits-tab" class="tab-content hidden"></div><div id="schedule-tab" class="tab-content hidden"></div><div id="settings-tab" class="tab-content hidden"></div></div></div></div>
    <div id="shop-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">Reward Shop</h2><button class="close-modal-btn text-gray-400 hover:text-white" data-modal="shop-modal">&times;</button></div><div id="shop-content" class="p-6 overflow-y-auto"></div><div class="p-4 border-t border-gray-700"><button id="log-toggle-btn" class="w-full btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">View Purchase History</button></div></div></div>
    <div id="result-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md text-center p-8"><h2 id="result-title" class="text-2xl font-bold mb-4"></h2><p id="result-message" class="text-brand-subtle mb-6"></p><div id="result-details" class="mb-6"></div><button id="result-ok-btn" class="btn w-full bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-6 rounded-lg">OK</button></div></div>
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md text-center p-8"><h2 class="text-2xl font-bold mb-4">Forfeit Feedback</h2><p class="text-brand-subtle mb-6">How difficult was that forfeit?</p><div class="flex justify-around"><button data-feedback="hard" class="btn feedback-btn bg-brand-danger hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg">Hard</button><button data-feedback="ok" class="btn feedback-btn bg-brand-warning hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-lg">About Right</button><button data-feedback="easy" class="btn feedback-btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg">Easy</button></div></div></div>
    <div id="edit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md p-6"><h2 id="edit-modal-title" class="text-2xl font-bold mb-6"></h2><form id="edit-form"></form><div class="mt-6 flex justify-end space-x-4"><button id="edit-cancel-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="edit-save-btn" class="btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-2 px-4 rounded-lg">Save</button></div></div></div>

<script type="module">
    const App = {
        state: {}, timerInterval: null, taskAssignmentInterval: null, interestInterval: null, // Added taskAssignmentInterval
        
        getDefaultState() {
            return {
                points: 100, tasksPerDay: 1, targetTasksToday: 1, // Added targetTasksToday
                activeTask: null, lastTaskDate: null,
                dailyTasksAssigned: 0, rewardsRedeemedToday: 0, lastPriceCheckDate: null,
                saleIsOn: false, rewardLog: [], soundInitialized: false,
                taskDurationHours: 2, compliance: 100, compliancePenalty: 20,
                skipPasses: 0, totalTasksCompleted: 0,
                currentStreak: 0, lastStreakDate: null,
                debt: null, 
                schedule: { 0: { start: '00:00', end: '00:00' }, 1: { start: '09:00', end: '17:00' }, 2: { start: '09:00', end: '17:00' }, 3: { start: '09:00', end: '17:00' }, 4: { start: '09:00', end: '17:00' }, 5: { start: '09:00', end: '17:00' }, 6: { start: '00:00', end: '00:00' }, },
                tasks: [ { id: 't1', name: 'Pushups', value: 10, unit: 'reps', points: 10, enabled: true, consecutiveSuccesses: 0, scheduledDay: 'any' }, { id: 't2', name: 'Pull ups', value: 5, unit: 'reps', points: 20, enabled: true, consecutiveSuccesses: 0, scheduledDay: 'any' }, ],
                rewards: [ { id: 'r1', name: 'Eat Candy', points: 50, enabled: true }, { id: 'r2', name: '30min Me Time', points: 100, enabled: true }, ],
                forfeits: {
                    tasks: [ { id: 'ft1', name: 'Face the corner', enabled: true }, { id: 'ft2', name: 'Face the wall', enabled: true }, ],
                    positions: [ { id: 'fp1', name: 'Hands in air', enabled: true }, { id: 'fp2', name: 'Hands on hair', enabled: true }, ],
                    baseDuration: 900, 
                }
            };
        },

        saveState() { try { localStorage.setItem('taskmaster_state', JSON.stringify(this.state)); } catch (error) { console.error("FATAL: Could not save state!", error); } },
        loadState() {
            try {
                const s = localStorage.getItem('taskmaster_state');
                if (s) {
                    let loadedState = JSON.parse(s);
                    // Add defaults for potentially missing properties in old saves
                    if (!loadedState.schedule) { loadedState.schedule = this.getDefaultState().schedule; }
                    if (!loadedState.forfeits.baseDuration) { loadedState.forfeits.baseDuration = loadedState.forfeits.duration || 900; } 
                    if (!loadedState.targetTasksToday) { loadedState.targetTasksToday = loadedState.tasksPerDay || 1; } // Estimate if missing
                    if(loadedState.tasks) { loadedState.tasks.forEach(t => { if (t.scheduledDay === undefined) t.scheduledDay = 'any'; if (t.consecutiveSuccesses === undefined) t.consecutiveSuccesses = 0; }); }
                    if(loadedState.rewards) { loadedState.rewards.forEach(r => { if (r.enabled === undefined) r.enabled = true; }); }
                    this.state = { ...this.getDefaultState(), ...loadedState };
                } else { this.state = this.getDefaultState(); }
            } catch (error) { console.error("Error loading state, resetting to default:", error); localStorage.removeItem('taskmaster_state'); this.state = this.getDefaultState(); }
        },

        init() { this.loadState(); this.attachEventListeners(); if (!this.state.soundInitialized) { this.showModal('sound-modal'); } else { this.runStartupLogic(); } },
        runStartupLogic() { this.checkDateAndReset(); this.checkStreak(); this.checkAndAdjustPrices(); this.render(); this.startTaskAssignmentChecks(); if(this.state.debt) { this.startInterestCalculation(); } },
        
        attachEventListeners() {
            document.getElementById('enable-sound-btn').addEventListener('click', async () => { await Tone.start(); this.state.soundInitialized = true; this.saveState(); this.hideModal('sound-modal'); this.runStartupLogic(); });
            document.getElementById('manage-btn').addEventListener('click', () => this.showModal('manage-modal'));
            document.getElementById('shop-btn').addEventListener('click', () => { if (this.state.compliance <= 50 && !this.state.debt) { this.showResult('Shop Privileges Revoked!', `Compliance is at ${this.state.compliance}%. Get it above 50% to regain access.`); } else { this.renderShopModal(true); this.showModal('shop-modal'); } });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', e => this.hideModal(e.target.dataset.modal)));
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', e => this.switchTab(e.target)));
            document.getElementById('main-content').addEventListener('click', e => { if (e.target.id === 'complete-task-btn') this.completeTask(); if (e.target.id === 'skip-task-btn') this.skipTask(); if (e.target.id === 'complete-forfeit-btn') this.completeForfeit(); });
            document.getElementById('result-ok-btn').addEventListener('click', () => { this.hideModal('result-modal'); this.render(); }); // Don't check for new task here
            document.querySelectorAll('.feedback-btn').forEach(btn => btn.addEventListener('click', e => this.handleForfeitFeedback(e.target.dataset.feedback)));
            document.getElementById('edit-cancel-btn').addEventListener('click', () => this.hideModal('edit-modal'));
            document.getElementById('edit-save-btn').addEventListener('click', () => this.handleSave());
            document.getElementById('shop-modal').addEventListener('click', e => { if (e.target.classList.contains('redeem-reward-btn')) this.redeemReward(e); if (e.target.classList.contains('borrow-reward-btn')) this.borrowReward(e); });
            document.getElementById('log-toggle-btn').addEventListener('click', e => { const i = e.target.textContent.includes('History'); this.renderShopModal(!i); });
        },
        
        playNotificationSound() { if (this.state.soundInitialized) { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("C5", "8n"); } },

        checkDateAndReset() { 
            const today = dayjs().format('YYYY-MM-DD');
            if (this.state.lastTaskDate !== today) {
                this.state.lastTaskDate = today;
                this.state.dailyTasksAssigned = 0;
                // Calculate target tasks for the new day
                const baseTasks = this.state.tasksPerDay;
                const variation = Math.round(baseTasks * 0.2);
                const randomVariation = Math.floor(Math.random() * (variation * 2 + 1)) - variation;
                this.state.targetTasksToday = Math.max(1, Math.min(12, baseTasks + randomVariation));
                console.log(`New day started. Target tasks for today: ${this.state.targetTasksToday}`);
                this.saveState();
            } else if (!this.state.targetTasksToday) { // Ensure target exists if loaded from old save
                 this.state.targetTasksToday = this.state.tasksPerDay; // Fallback
            }
        },
        checkAndAdjustPrices() { const t=dayjs().format('YYYY-MM-DD');if(this.state.lastPriceCheckDate&&this.state.lastPriceCheckDate!==t){ const a=this.state.rewards.filter(r=>r.enabled); if(this.state.rewardsRedeemedToday>=3){a.forEach(r=>r.points=Math.round(r.points*1.05));this.state.saleIsOn=false;}else if(this.state.rewardsRedeemedToday===0){a.forEach(r=>r.points=Math.max(1,Math.round(r.points*0.95)));this.state.saleIsOn=true;}else{this.state.saleIsOn=false;} this.state.rewardsRedeemedToday=0;} this.state.lastPriceCheckDate=t; this.saveState(); },
        checkStreak() { if (!this.state.lastStreakDate) return; const today = dayjs().startOf('day'); const lastDate = dayjs(this.state.lastStreakDate).startOf('day'); if (today.diff(lastDate, 'day') > 1) { this.state.currentStreak = 0; } },
        isWithinScheduledTime() { const n=dayjs(),d=n.day(),s=this.state.schedule[d]; if(!s||s.start==='00:00'&&s.end==='00:00'){return false;} const t=dayjs(s.start,'HH:mm'),e=dayjs(s.end,'HH:mm'); if(e.isBefore(t)){return n.isAfter(t)||n.isBefore(e);}else{return n.isAfter(t)&&n.isBefore(e);} },
        
        startTaskAssignmentChecks() {
            clearInterval(this.taskAssignmentInterval); // Clear previous interval if any
            this.taskAssignmentInterval = setInterval(() => {
                this.checkAndAssignTask();
            }, 60000); // Check every minute
            console.log("Task assignment interval started.");
        },

        checkAndAssignTask() {
            if (this.state.activeTask) return; // Don't assign if busy
            if (!this.isWithinScheduledTime()) {
                 this.render(); // Update UI to show "Outside hours" if needed
                 return; 
            }
            if (this.state.dailyTasksAssigned >= this.state.targetTasksToday) {
                 this.render(); // Update UI to show "All tasks done" if needed
                 return; // All done for today
            }

            // Calculate probability
            const tasksRemaining = this.state.targetTasksToday - this.state.dailyTasksAssigned;
            const now = dayjs();
            const currentDay = now.day();
            const schedule = this.state.schedule[currentDay];
            let endTime = dayjs(schedule.end, 'HH:mm');
            // Adjust end time if it's on the next day (overnight schedule)
             if (endTime.isBefore(dayjs(schedule.start, 'HH:mm'))) {
                 endTime = endTime.add(1, 'day');
             }
             const minutesRemaining = Math.max(1, endTime.diff(now, 'minute')); // Avoid division by zero
             
             const assignProbability = Math.min(1, tasksRemaining / minutesRemaining); // Probability increases as time runs out
             
             console.log(`Checking for task: ${tasksRemaining} left, ${minutesRemaining} mins left. Prob: ${assignProbability.toFixed(2)}`);

             if (Math.random() < assignProbability) {
                 console.log("Assigning task based on probability.");
                 this.assignTask();
                 this.render(); // Render the new task
             } else {
                 console.log("Skipping assignment this minute.");
                 this.render(); // Ensure idle message is correct
             }
        },
        
        assignTask() {
            const today = dayjs().day();
            const scheduledTasks = this.state.tasks.filter(t => t.enabled && parseInt(t.scheduledDay) === today);
            const randomTasks = this.state.tasks.filter(t => t.enabled && t.scheduledDay === 'any');
            
            let taskToAssign = null;
            // Prioritize scheduled tasks that haven't been assigned yet today
            const assignedTaskIds = []; // Keep track if we were tracking specific assigned tasks
            let scheduledTaskIndex = this.state.dailyTasksAssigned; // Use daily count as index for scheduled
            
            if (scheduledTaskIndex < scheduledTasks.length) { 
                taskToAssign = scheduledTasks[scheduledTaskIndex]; 
                console.log("Assigning scheduled task:", taskToAssign.name);
            } else if (randomTasks.length > 0) { 
                taskToAssign = randomTasks[Math.floor(Math.random() * randomTasks.length)]; 
                console.log("Assigning random task:", taskToAssign.name);
            }
            
            if (taskToAssign) {
                let nameString = (taskToAssign.unit === 'area') ? `${taskToAssign.name}` : `${taskToAssign.value} ${taskToAssign.unit} ${taskToAssign.name}`;
                this.state.activeTask = { id: taskToAssign.id, name: nameString, assignedAt: Date.now(), type: 'task', points: taskToAssign.points };
                this.state.dailyTasksAssigned++;
                this.playNotificationSound();
                this.saveState(); 
            } else {
                 console.log("No available tasks to assign.");
            }
        },

        completeTask() { /* ... unchanged ... */ clearInterval(this.timerInterval); this.timerInterval = null; const task = this.state.activeTask; const originalTask = this.state.tasks.find(t => t.id === task.id); let detailsMessage = ''; if(originalTask) { originalTask.consecutiveSuccesses=(originalTask.consecutiveSuccesses||0)+1; if(originalTask.consecutiveSuccesses>=3&&originalTask.unit!=='area'){const o=originalTask.value;originalTask.value=Math.ceil(o*1.1);originalTask.consecutiveSuccesses=0;detailsMessage+=`<p class="text-brand-success mt-2">‚ú® ${originalTask.name} leveled up! New goal: ${originalTask.value} ${originalTask.unit}.</p>`;} } const today=dayjs().format('YYYY-MM-DD'),yesterday=dayjs().subtract(1,'day').format('YYYY-MM-DD'); if(this.state.lastStreakDate!==today){ if(this.state.lastStreakDate===yesterday){this.state.currentStreak++;} else{this.state.currentStreak=1;} this.state.lastStreakDate=today; detailsMessage+=`<p class="text-yellow-400 mt-2">üî• Daily Streak: ${this.state.currentStreak} day(s)!</p>`;} this.state.totalTasksCompleted++; if(this.state.totalTasksCompleted>0&&this.state.totalTasksCompleted%20===0){this.state.skipPasses++;detailsMessage+=`<p class="text-blue-400 mt-2">üéüÔ∏è You earned a Skip Pass!</p>`;} this.state.points += task.points; this.state.compliance = Math.min(100, this.state.compliance + 10); this.state.activeTask = null; this.saveState(); this.showResult('Task Complete!', `You earned ${task.points} points. Compliance is now ${this.state.compliance}%.`, detailsMessage); this.checkDebtRepayment(); this.render(); },
        skipTask() { /* ... unchanged ... */ if (this.state.skipPasses > 0) { clearInterval(this.timerInterval); this.timerInterval = null; this.state.skipPasses--; this.state.activeTask = null; this.saveState(); this.showResult('Task Skipped', `You used a skip pass. You have ${this.state.skipPasses} remaining.`); this.render(); } },
        failTaskByTimer() { /* ... unchanged ... */ if (!this.state.activeTask || this.state.activeTask.type !== 'task') return; clearInterval(this.timerInterval); this.timerInterval = null; const failedTask = { ...this.state.activeTask }; let detailsMessage = ''; const originalTask = this.state.tasks.find(t => t.id === failedTask.id); if(originalTask) { originalTask.consecutiveSuccesses = 0; if (originalTask.unit !== 'area') { const o=originalTask.value; originalTask.value = Math.max(1, Math.floor(o * 0.9)); detailsMessage = `<p class="text-brand-danger mt-2">üîª ${originalTask.name} difficulty reduced to ${originalTask.value} ${originalTask.unit}.</p>`; } } const newCompliance = Math.max(0, this.state.compliance - this.state.compliancePenalty); const newForfeit = this.calculateForfeit(); this.state.activeTask = newForfeit; this.state.compliance = newCompliance; this.state.currentStreak = 0; this.saveState(); this.render(); if (newForfeit) { this.showResult("Time's Up!", `A forfeit has been assigned. Compliance is now ${this.state.compliance}%. Your streak is broken.`, detailsMessage); } else { this.showResult('Forfeit Skipped', `Task failed, but no forfeits are enabled. Compliance is now ${this.state.compliance}%. Your streak is broken.`, detailsMessage); } },
        calculateForfeit() { /* ... unchanged ... */ const t=this.state.forfeits.tasks.filter(t=>t.enabled),p=this.state.forfeits.positions.filter(p=>p.enabled);if(t.length===0||p.length===0){return null;} const r=t[Math.floor(Math.random()*t.length)],o=p[Math.floor(Math.random()*p.length)];return{id:`f-${Date.now()}`,name:r.name,position:o.name,currentDuration:this.state.forfeits.baseDuration,assignedAt:Date.now(),type:'forfeit', lastPenaltyHour: 0}; },
        completeForfeit() { /* ... unchanged ... */ clearInterval(this.timerInterval); this.timerInterval = null; this.showModal('feedback-modal'); },
        handleForfeitFeedback(f){ /* ... unchanged ... */ const d=this.state.forfeits.baseDuration; if(f==='easy'){this.state.forfeits.baseDuration=Math.round(d*1.1);if(this.state.tasksPerDay<12)this.state.tasksPerDay++;} else if(f==='ok'){this.state.forfeits.baseDuration=Math.round(d*1.05);} else if(f==='hard'){this.state.forfeits.baseDuration=Math.max(60,Math.round(d*.9));if(this.state.tasksPerDay>1)this.state.tasksPerDay--;} this.state.activeTask=null; this.hideModal('feedback-modal'); this.saveState(); this.showResult('Forfeit Complete','Discipline administered. Get back to it.'); this.render(); },
        borrowReward(e) { /* ... unchanged ... */ if (this.state.debt) { this.showResult('Error', 'You already have an outstanding debt. Pay it off first.'); return; } const { id } = e.target.dataset; const reward = this.state.rewards.find(r => r.id === id); if (reward && this.state.points < reward.points) { const now = Date.now(); this.state.debt = { rewardId: reward.id, rewardName: reward.name, initialCost: reward.points, amountOwed: reward.points - this.state.points, borrowedAt: now, lastInterestCalc: now }; this.state.points = 0; this.saveState(); this.startInterestCalculation(); this.render(); this.hideModal('shop-modal'); this.showResult('Reward Borrowed', `You borrowed "${reward.name}". You now owe ${this.state.debt.amountOwed} points. Interest will accrue hourly.`); } },
        startInterestCalculation() { clearInterval(this.interestInterval); this.interestInterval = setInterval(() => { if (!this.state.debt) { clearInterval(this.interestInterval); return; } const now = Date.now(); const hoursPassed = Math.floor((now - this.state.debt.lastInterestCalc) / 3600000); if (hoursPassed > 0) { for (let i = 0; i < hoursPassed; i++) { this.state.debt.amountOwed = Math.ceil(this.state.debt.amountOwed * 1.01); } this.state.debt.lastInterestCalc = now; this.saveState(); this.renderHeader(); console.log(`Interest applied. New debt: ${this.state.debt.amountOwed}`); } }, 300000); },
        checkDebtRepayment() { /* ... unchanged ... */ if (this.state.debt && this.state.points >= this.state.debt.amountOwed) { this.state.points -= this.state.debt.amountOwed; const settledDebtName = this.state.debt.rewardName; this.state.debt = null; clearInterval(this.interestInterval); this.interestInterval = null; this.saveState(); this.showResult('Debt Settled!', `Your debt for "${settledDebtName}" has been paid off!`); } },
        redeemReward(e){const{id:t}=e.target.dataset,r=this.state.rewards.find(r=>r.id===t);if(r&&this.state.points>=r.points){this.state.points-=r.points;this.state.rewardsRedeemedToday++;this.state.rewardLog.unshift({name:r.name,points:r.points,redeemedAt:Date.now()});this.saveState();this.render();this.renderShopModal(true);this.showResult('Reward Claimed!',`You redeemed "${r.name}" for ${r.points} points.`);}},
        
        render() { this.renderMainContent(); this.renderManagement(); this.renderHeader(); this.renderComplianceBar(); },
        
        renderHeader() { /* ... unchanged ... */ const pointsDebtContainer = document.getElementById('points-debt-display'); if (this.state.debt) { pointsDebtContainer.innerHTML = `<p class="text-brand-subtle text-sm">Debt Owed</p><p id="debt-display" class="text-2xl font-bold text-brand-danger">${Math.ceil(this.state.debt.amountOwed)}</p>`; } else { pointsDebtContainer.innerHTML = `<p class="text-brand-subtle text-sm">Points</p><p id="points-display" class="text-2xl font-bold text-brand-accent">${this.state.points}</p>`; } const s = document.getElementById('streak-display'); if (this.state.currentStreak > 0) { s.innerHTML = `<p class="text-brand-subtle text-sm">Streak</p><p class="text-2xl font-bold text-yellow-400">üî• ${this.state.currentStreak}</p>`; } else { s.innerHTML = ''; } },
        renderComplianceAvatar() { /* ... unchanged ... */ const avatar = document.getElementById('compliance-avatar-main'); if (avatar) { let imgNum = 6; if (this.state.compliance >= 100) imgNum = 1; else if (this.state.compliance >= 90) imgNum = 2; else if (this.state.compliance >= 80) imgNum = 3; else if (this.state.compliance >= 70) imgNum = 4; else if (this.state.compliance >= 60) imgNum = 5; avatar.src = `${imgNum}.png`; } },
        renderMainContent() {
            const mainContent = document.getElementById('main-content');
            const avatarHtml = `<img id="compliance-avatar-main" src="1.png" alt="Compliance Status" class="h-20 w-20 md:h-24 md:w-24 rounded border-2 border-gray-600 object-cover flex-shrink-0" onerror="this.src='https://placehold.co/96x96/2c2c2c/a3a3a3?text=Err'">`;
            let contentHtml = '';

            if (this.state.activeTask && this.state.activeTask.type === 'task') { contentHtml = this.getTaskHtml(); } 
            else if (this.state.activeTask && this.state.activeTask.type === 'forfeit') { contentHtml = this.getForfeitHtml(); } 
            else {
                 if (!this.isWithinScheduledTime()) { 
                     contentHtml = `<div class="text-left flex-grow"><h2 class="text-2xl font-bold text-brand-text mb-2">Outside Active Hours.</h2><p class="text-brand-subtle">Standing by.</p></div>`; 
                 } else if (this.state.dailyTasksAssigned >= this.state.targetTasksToday) {
                     contentHtml = `<div class="text-left flex-grow"><h2 class="text-2xl font-bold text-brand-text mb-2">All Tasks Assigned.</h2><p class="text-brand-subtle">Check back tomorrow.</p></div>`;
                 } else { 
                     const e=this.state.tasks.filter(t=>t.enabled); 
                     if(e.length===0){
                         contentHtml = `<div class="text-left flex-grow"><h2 class="text-2xl font-bold text-brand-warning mb-2">No Tasks Enabled</h2><p class="text-brand-subtle">Go to 'Manage' and add tasks to your roster.</p></div>`;
                     } else {
                         contentHtml = `<div class="text-left flex-grow"><h2 class="text-2xl font-bold text-brand-text mb-2">Awaiting Orders.</h2><p class="text-brand-subtle">Stand by for your next assignment.</p></div>`;
                     } 
                 }
            }
            mainContent.innerHTML = `<div class="flex items-center space-x-6 w-full">${avatarHtml}${contentHtml}</div>`;
            this.renderComplianceAvatar(); 
            this.startTimerIfNeeded(); 
        },
        getTaskHtml() { /* ... unchanged ... */ const t = this.state.activeTask; const skipButton = this.state.skipPasses > 0 ? `<button id="skip-task-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg text-sm">Skip Task (${this.state.skipPasses})</button>` : ''; return `<div class="text-left flex-grow"> <p class="text-brand-subtle mb-1 text-sm">Your Orders:</p> <h2 class="text-2xl md:text-3xl font-bold text-brand-text mb-3">${t.name}</h2> <div class="text-lg text-brand-warning mb-4" id="timer">Calculating...</div> <div class="flex justify-start space-x-4"> <button id="complete-task-btn" class="btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-sm">Complete</button> ${skipButton} </div> </div>`; },
        getForfeitHtml() { /* ... unchanged ... */ const f = this.state.activeTask; return `<div class="text-left flex-grow"> <p class="text-brand-subtle mb-1 text-sm">Your Forfeit:</p> <h2 class="text-2xl md:text-3xl font-bold text-brand-danger mb-2">${f.name}</h2> <p class="text-lg text-brand-subtle mb-2">Position: ${f.position}</p> <div class="text-lg text-brand-warning mb-1" id="forfeit-timer">Calculating...</div> <p id="total-forfeit-duration" class="text-xs text-brand-warning mb-4"></p> <button id="complete-forfeit-btn" class="btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-6 rounded-lg text-sm">Forfeit Completed</button> </div>`; },
        startTimerIfNeeded() { /* ... unchanged ... */ clearInterval(this.timerInterval); this.timerInterval = null; if (this.state.activeTask?.type === 'task') { const t = this.state.activeTask; const d = t.assignedAt + (this.state.taskDurationHours * 60 * 60 * 1000); const e = document.getElementById('timer'); if(!e) return; this.timerInterval = setInterval(() => { const s = d - Date.now(); if (s <= 0) { clearInterval(this.timerInterval); this.failTaskByTimer(); } else { const h=Math.floor(s/36e5),m=Math.floor(s%36e5/6e4),c=Math.floor(s%6e4/1e3); if(e) e.textContent=`Time left: ${h}h ${m}m ${c}s`; } }, 1000); } else if (this.state.activeTask?.type === 'forfeit') { const f = this.state.activeTask; const baseDuration = this.state.forfeits.baseDuration; const timerEl = document.getElementById('forfeit-timer'); const totalDurationEl = document.getElementById('total-forfeit-duration'); if(!timerEl || !totalDurationEl) return; const updateTimerDisplay = () => { const now = Date.now(); let deadline = f.assignedAt + (f.currentDuration * 1000); const timeLeft = deadline - now; const currentTotalDurationStr = dayjs.duration(f.currentDuration, 'seconds').format('H[h] m[m] s[s]'); totalDurationEl.textContent = `(Total required: ${currentTotalDurationStr})`; if (timeLeft > 0) { const h=Math.floor(timeLeft/36e5),m=Math.floor(timeLeft%36e5/6e4),s=Math.floor(timeLeft%6e4/1e3); timerEl.textContent = `Time left: ${h}h ${m}m ${s}s`; timerEl.classList.remove('text-brand-danger'); timerEl.classList.add('text-brand-warning'); } else { const overdue = now - deadline; const oh=Math.floor(overdue/36e5),om=Math.floor(overdue%36e5/6e4),os=Math.floor(overdue%6e4/1e3); timerEl.textContent = `Overdue by: ${oh}h ${om}m ${os}s`; timerEl.classList.add('text-brand-danger'); timerEl.classList.remove('text-brand-warning'); const originalDeadline = f.assignedAt + (baseDuration * 1000); const totalOverdueMillis = Math.max(0, now - originalDeadline); const hoursOverdue = Math.floor(totalOverdueMillis / 3600000); if (hoursOverdue >= (f.lastPenaltyHour || 0) + 1) { const penaltyMultiplier = hoursOverdue; f.currentDuration = baseDuration * (1 + penaltyMultiplier); f.lastPenaltyHour = hoursOverdue; this.saveState(); console.log(`Forfeit duration increased to ${f.currentDuration} seconds`); } } }; updateTimerDisplay(); this.timerInterval = setInterval(updateTimerDisplay, 1000); } },
        renderComplianceBar() { /* ... unchanged ... */ const bar = document.getElementById('compliance-bar'); const text = document.getElementById('compliance-text'); if (bar && text) { bar.style.width = `${this.state.compliance}%`; text.textContent = `Compliance: ${this.state.compliance}%`; } },
        switchTab(e){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('tab-active'));e.classList.add('tab-active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));document.getElementById(`${e.dataset.tab}-tab`).classList.remove('hidden');this.renderManagement();},
        renderManagement(){ const a=document.querySelector('#manage-modal .tab-active').dataset.tab; if(a==='tasks')this.renderList('tasks',this.state.tasks,['name','value','unit','points','scheduledDay']); if(a==='rewards')this.renderList('rewards',this.state.rewards,['name','points']); if(a==='forfeits')this.renderForfeitsTab(); if(a==='schedule')this.renderScheduleTab(); if(a==='settings')this.renderSettingsTab(); },
        renderShopModal(s){ /* ... unchanged ... */ const c=document.getElementById('shop-content'), t=document.getElementById('log-toggle-btn'); if(s) { const a = this.state.saleIsOn ? `<div class="bg-green-500/20 border border-green-500 text-green-300 text-center p-3 rounded-lg mb-4">üî• **REWARD SALE ON!** All prices are 5% off today! üî•</div>`:''; const hasDebt = !!this.state.debt; const debtMessage = hasDebt ? `<div class="bg-red-500/20 border border-red-500 text-red-300 text-center p-3 rounded-lg mb-4">Shop access suspended until debt of ${Math.ceil(this.state.debt.amountOwed)} points is settled.</div>` : ''; const i=this.state.rewards.filter(r => r.enabled).map(item=>{ const n=this.state.points >= item.points; const canBorrow = !hasDebt && !n; let buttonHtml = ''; if (n) { buttonHtml = `<button class="btn redeem-reward-btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-1 px-3 rounded-md text-sm" data-id="${item.id}" ${hasDebt ? 'disabled' : ''}>Redeem</button>`; } else if (canBorrow) { buttonHtml = `<button class="btn borrow-reward-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-1 px-3 rounded-md text-sm" data-id="${item.id}">Borrow</button>`; } else { buttonHtml = `<button class="btn bg-gray-600 text-white font-bold py-1 px-3 rounded-md text-sm" data-id="${item.id}" disabled>Unavailable</button>`; } return` <div class="flex items-center justify-between p-3 rounded-lg bg-brand-primary mb-2 ${!n && !canBorrow ? 'opacity-50' : ''}"> <div> <p class="font-semibold">${item.name}</p> <p class="text-sm font-bold ${this.state.saleIsOn?'text-green-400':'text-brand-accent'}">${item.points} Points</p> </div> ${buttonHtml} </div>`; }).join(''); c.innerHTML= debtMessage + a + (i.length > 0 ? i : '<p class="text-brand-subtle">No rewards enabled. Go to Manage -> Rewards.</p>'); t.textContent='View Purchase History'; } else { let l='<h3 class="text-lg font-bold mb-4">Purchase History</h3>';if(this.state.rewardLog.length===0){l+='<p class="text-brand-subtle">You haven\'t purchased any rewards yet.</p>';}else{l+=this.state.rewardLog.map(log=>` <div class="flex justify-between items-center p-2 bg-brand-primary rounded-md mb-2"> <div> <p class="font-semibold">${log.name}</p> <p class="text-xs text-brand-subtle">${dayjs(log.redeemedAt).fromNow()}</p> </div> <p class="font-bold text-brand-accent">${log.points}</p> </div>`).join('');}c.innerHTML=l;t.textContent='Back to Shop'; } },
        renderList(t,i,f){const c=document.getElementById(`${t}-tab`),h=i.map(item=>{ let details = f.slice(1).map(k=>{ if(k==='scheduledDay'){const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; return `Schedule: ${item[k]==='any'?'Any':days[item[k]]}`;} else { return `${k.charAt(0).toUpperCase()+k.slice(1)}: ${item[k]}`; } }).join(', '); return `<div class="flex items-center justify-between p-3 rounded-lg bg-brand-primary mb-2"><div class="flex items-center"><label class="flex items-center cursor-pointer mr-4"><input type="checkbox" class="form-checkbox h-5 w-5 text-brand-accent bg-gray-800 border-gray-600 rounded focus:ring-brand-accent" data-type="${t}" data-id="${item.id}" ${item.enabled?'checked':''}></label><div><p class="font-semibold ${item.enabled?'':'line-through text-gray-500'}">${item.name}</p><p class="text-sm text-brand-subtle">${details}</p></div></div><div><button class="edit-item-btn text-brand-subtle hover:text-white mr-2" data-type="${t}" data-id="${item.id}">Edit</button><button class="delete-item-btn text-brand-danger hover:text-red-400" data-type="${t}" data-id="${item.id}">Delete</button></div></div>`; }).join('');c.innerHTML=`<div class="mb-6">${h}</div><button class="add-item-btn w-full btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-4 rounded-lg" data-type="${t}">Add New ${t.slice(0,-1)}</button>`;c.querySelectorAll('.form-checkbox').forEach(b=>b.addEventListener('change',e=>this.toggleEnable(e)));c.querySelectorAll('.delete-item-btn').forEach(b=>b.addEventListener('click',e=>this.deleteItem(e)));c.querySelectorAll('.add-item-btn').forEach(b=>b.addEventListener('click',e=>this.handleAddItem(e)));c.querySelectorAll('.edit-item-btn').forEach(b=>b.addEventListener('click',e=>this.handleEditItem(e)));},
        renderForfeitsTab(){const c=document.getElementById('forfeits-tab'),{tasks:t,positions:p}=this.state.forfeits,r=(s,l)=>l.map(i=>`<div class="flex items-center justify-between p-3 rounded-lg bg-brand-primary mb-2"><div class="flex items-center"><label class="flex items-center cursor-pointer mr-4"><input type="checkbox" class="form-checkbox h-5 w-5 text-brand-accent bg-gray-800 border-gray-600 rounded focus:ring-brand-accent" data-type="forfeits" data-subtype="${s}" data-id="${i.id}" ${i.enabled?'checked':''}></label><p class="font-semibold ${i.enabled?'':'line-through text-gray-500'}">${i.name}</p></div><div><button class="delete-item-btn text-brand-danger hover:text-red-400" data-type="forfeits" data-id="${i.id}">Delete</button></div></div>`).join('');c.innerHTML=`<div class="mb-4"><h3 class="text-lg font-semibold mb-2">Forfeit Tasks</h3>${r('tasks',t)}<button class="add-item-btn w-full btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-2 px-4 rounded-lg mt-2" data-type="forfeits" data-subtype="tasks">Add New Task</button></div><div class="mb-4"><h3 class="text-lg font-semibold mb-2">Forfeit Positions</h3>${r('positions',p)}<button class="add-item-btn w-full btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-2 px-4 rounded-lg mt-2" data-type="forfeits" data-subtype="positions">Add New Position</button></div>`;c.querySelectorAll('.form-checkbox').forEach(b=>b.addEventListener('change',e=>this.toggleEnable(e)));c.querySelectorAll('.delete-item-btn').forEach(b=>b.addEventListener('click',e=>this.deleteItem(e)));c.querySelectorAll('.add-item-btn').forEach(b=>b.addEventListener('click',e=>this.handleAddItem(e)));},
        renderScheduleTab() { /* ... unchanged ... */ const c=document.getElementById('schedule-tab'); const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']; let h='<p class="text-brand-subtle mb-4">Set start/end times for tasks each day. Set both to 00:00 to disable tasks.</p>'; days.forEach((day,idx)=>{ const ds=this.state.schedule[idx]||{start:'00:00',end:'00:00'}; h+=`<div class="bg-brand-primary p-4 rounded-lg mb-3"><label class="block text-lg font-semibold mb-2">${day}</label><div class="flex space-x-4"><div class="flex-1"><label class="block text-sm text-brand-subtle mb-1">Start Time</label><input type="time" id="start-${idx}" value="${ds.start}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"></div><div class="flex-1"><label class="block text-sm text-brand-subtle mb-1">End Time</label><input type="time" id="end-${idx}" value="${ds.end}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"></div></div></div>`; }); h+=`<div class="mt-6"><button id="save-schedule-btn" class="w-full btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Save Schedule</button></div>`; c.innerHTML=h; document.getElementById('save-schedule-btn').addEventListener('click',()=>{ days.forEach((_,idx)=>{ const s=document.getElementById(`start-${idx}`).value,e=document.getElementById(`end-${idx}`).value; this.state.schedule[idx]={start:s,end:e}; }); this.saveState(); this.showResult("Schedule Saved","Your task schedule has been updated."); }); },
        renderSettingsTab(){/* ... unchanged ... */ const c=document.getElementById('settings-tab');c.innerHTML=`<div class="bg-brand-primary p-4 rounded-lg"><label for="tasks-per-day" class="block text-lg font-semibold mb-2">Tasks Per Day</label><input type="number" id="tasks-per-day" min="1" max="12" value="${this.state.tasksPerDay}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"><p class="text-sm text-brand-subtle mt-2">Set how many tasks you want to be assigned each day (1-12).</p></div> <div class="bg-brand-primary p-4 rounded-lg mt-4"><label for="task-duration" class="block text-lg font-semibold mb-2">Task Duration (hours)</label><input type="number" id="task-duration" min="1" max="24" value="${this.state.taskDurationHours}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"><p class="text-sm text-brand-subtle mt-2">Set how long you have to complete a task.</p></div> <div class="bg-brand-primary p-4 rounded-lg mt-4"><label for="forfeit-duration" class="block text-lg font-semibold mb-2">Base Forfeit Duration (minutes)</label><input type="number" id="forfeit-duration" min="1" value="${this.state.forfeits.baseDuration/60}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"></div> <div class="mt-6"><button id="save-settings-btn" class="w-full btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Save Settings</button></div>`;document.getElementById('save-settings-btn').addEventListener('click',()=>{this.state.tasksPerDay=parseInt(document.getElementById('tasks-per-day').value,10);this.state.taskDurationHours=parseInt(document.getElementById('task-duration').value,10);this.state.forfeits.baseDuration=parseInt(document.getElementById('forfeit-duration').value,10)*60;this.saveState();this.showResult("Settings Saved","Your new settings have been applied.");});},
        toggleEnable(e){const{type:t,id:i,subtype:s}=e.target.dataset;let a;if(t==='forfeits'){a=this.state.forfeits[s].find(item=>item.id===i);}else{a=this.state[t].find(item=>item.id===i);}if(a){a.enabled=e.target.checked;this.saveState();this.renderManagement();}},
        deleteItem(e){const{type:t,id:i,subtype:s}=e.target.closest('button').dataset;if(confirm('Are you sure you want to delete this item?')){if(t==='forfeits'){this.state.forfeits[s]=this.state.forfeits[s].filter(item=>item.id!==i);}else{this.state[t]=this.state[t].filter(item=>item.id!==i);}this.saveState();this.renderManagement();}},
        handleAddItem(e){const{type:t,subtype:s}=e.target.dataset;this.openEditModal(t,null,s);},
        handleEditItem(e){const{type:t,id:i}=e.target.closest('button').dataset;this.openEditModal(t,i);},
        openEditModal(t,i,s=null){const n=i===null;let a=n?{}:t==='forfeits'?this.state.forfeits[s].find(item=>item.id===i):this.state[t].find(item=>item.id===i);const o=document.getElementById('edit-form');let d='';let l=`${n?'Add':'Edit'} ${s||t.slice(0,-1)}`;const f={tasks:{name:'text',value:'number',unit:'text',points:'number', scheduledDay:'select'},rewards:{name:'text',points:'number'},forfeits:{name:'text'}};const c=f[t];for(const[k,p]of Object.entries(c)){d+=`<div class="mb-4"><label class="block text-brand-subtle text-sm font-bold mb-2" for="${k}">${k.charAt(0).toUpperCase()+k.slice(1)}</label>`;if(p==='select'){const days=['Any Day (Random)','Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];d+=`<select class="shadow appearance-none border rounded w-full py-2 px-3 bg-brand-primary border-gray-600 text-white" id="${k}">${days.map((day,idx)=>`<option value="${idx===0?'any':idx-1}" ${ (a[k] === (idx === 0 ? 'any' : (idx-1).toString())) ? 'selected':''}>${day}</option>`).join('')}</select>`;}else{d+=`<input class="shadow appearance-none border rounded w-full py-2 px-3 bg-brand-primary border-gray-600 text-white leading-tight focus:outline-none focus:shadow-outline" id="${k}" type="${p}" placeholder="${k}" value="${a[k]||''}">`;}d+='</div>';}o.innerHTML=d;document.getElementById('edit-modal-title').textContent=l;o.dataset.type=t;o.dataset.id=i;if(s)o.dataset.subtype=s;else delete o.dataset.subtype;this.showModal('edit-modal');},
        handleSave(){const f=document.getElementById('edit-form'),{type:t,id:i,subtype:s}=f.dataset,n=i==='null';let a=n?{id:`${t.charAt(0)}${Date.now()}`,enabled:true}:{}; if(t==='tasks' && n) a.consecutiveSuccesses=0; if(t==='rewards' && n) a.enabled = true; const d=f.querySelectorAll('input, select');d.forEach(field=>{if(field.type==='number'){a[field.id]=parseInt(field.value,10)||0;}else{a[field.id]=field.value;}});if(n){if(t==='forfeits'){this.state.forfeits[s].push(a);}else{this.state[t].push(a);}}else{let c=t==='forfeits'?this.state.forfeits[s]:this.state[t];const e=c.findIndex(item=>item.id===i);if(e>-1){c[e]={...c[e],...a};}}this.saveState();this.renderManagement();this.hideModal('edit-modal');},

        showModal(id){document.getElementById(id).classList.remove('hidden');}, hideModal(id){document.getElementById(id).classList.add('hidden');},
        showResult(t,m,d=''){document.getElementById('result-title').textContent=t;document.getElementById('result-message').textContent=m;document.getElementById('result-details').innerHTML=d;this.showModal('result-modal');},
    };

    document.addEventListener('DOMContentLoaded', () => { App.init(); });
</script>

</body>
</html>

