<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster: Your Life Gamified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <!-- Sound Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_relativeTime);
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-primary': '#1a1a1a',
                        'brand-secondary': '#2c2c2c',
                        'brand-accent': '#4f46e5',
                        'brand-accent-hover': '#4338ca',
                        'brand-text': '#f5f5f5',
                        'brand-subtle': '#a3a3a3',
                        'brand-success': '#22c55e',
                        'brand-warning': '#facc15',
                        'brand-danger': '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #1a1a1a; color: #f5f5f5; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
        .task-card { background: linear-gradient(145deg, #2e2e2e, #262626); box-shadow: 8px 8px 16px #1e1e1e, -8px -8px 16px #343434; }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .tab-active { border-bottom-color: #4f46e5; color: #f5f5f5; }
        .tab { border-bottom-color: transparent; color: #a3a3a3; }
        #compliance-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl font-sans">
        
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-brand-text">TaskMaster</h1>
            <div class="flex items-center space-x-4">
                <div id="streak-display" class="text-right">
                    <!-- Streak will be rendered here -->
                </div>
                <div class="text-right">
                    <p class="text-brand-subtle text-sm">Points</p>
                    <p id="points-display" class="text-2xl font-bold text-brand-accent">0</p>
                </div>
                <button id="shop-btn" class="btn bg-brand-secondary p-3 rounded-full hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-text" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </button>
            </div>
        </header>

        <main id="main-content" class="text-center p-8 rounded-2xl task-card min-h-[300px] flex flex-col justify-center items-center">
            <!-- Populated by JS -->
        </main>

        <!-- Compliance Bar -->
        <div id="compliance-container" class="mt-8">
            <div class="w-full bg-brand-danger rounded-full h-6 border-2 border-gray-600 relative overflow-hidden">
                <div id="compliance-bar" class="bg-brand-success h-full rounded-full"></div>
                <div id="compliance-text" class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.7);"></div>
            </div>
        </div>

        <footer class="mt-4 flex justify-center">
            <button id="manage-btn" class="btn bg-brand-secondary hover:bg-gray-700 text-brand-text font-bold py-3 px-6 rounded-lg shadow-lg">Manage Your Setup</button>
        </footer>

    </div>

    <!-- Modals -->
    <div id="sound-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-sm text-center p-8"><h2 class="text-2xl font-bold mb-4">Enable Sound</h2><p class="text-brand-subtle mb-6">Click the button below to enable sound notifications for new tasks.</p><button id="enable-sound-btn" class="btn w-full bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-6 rounded-lg">Enable Sound</button></div></div>
    <div id="manage-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">Manage Your Setup</h2><button class="close-modal-btn text-gray-400 hover:text-white" data-modal="manage-modal">&times;</button></div><div class="flex border-b border-gray-700 px-6"><button data-tab="tasks" class="tab tab-active text-lg font-semibold py-4 mr-6">Tasks</button><button data-tab="forfeits" class="tab text-lg font-semibold py-4 mr-6">Forfeits</button><button data-tab="settings" class="tab text-lg font-semibold py-4">Settings</button></div><div class="p-6 overflow-y-auto"><div id="tasks-tab" class="tab-content"></div><div id="forfeits-tab" class="tab-content hidden"></div><div id="settings-tab" class="tab-content hidden"></div></div></div></div>
    <div id="shop-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">Reward Shop</h2><button class="close-modal-btn text-gray-400 hover:text-white" data-modal="shop-modal">&times;</button></div><div id="shop-content" class="p-6 overflow-y-auto"></div><div class="p-4 border-t border-gray-700"><button id="log-toggle-btn" class="w-full btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">View Purchase History</button></div></div></div>
    <div id="result-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md text-center p-8"><h2 id="result-title" class="text-2xl font-bold mb-4"></h2><p id="result-message" class="text-brand-subtle mb-6"></p><div id="result-details" class="mb-6"></div><button id="result-ok-btn" class="btn w-full bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-6 rounded-lg">OK</button></div></div>
    <div id="feedback-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md text-center p-8"><h2 class="text-2xl font-bold mb-4">Forfeit Feedback</h2><p class="text-brand-subtle mb-6">How difficult was that forfeit?</p><div class="flex justify-around"><button data-feedback="hard" class="btn feedback-btn bg-brand-danger hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg">Hard</button><button data-feedback="ok" class="btn feedback-btn bg-brand-warning hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-lg">About Right</button><button data-feedback="easy" class="btn feedback-btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg">Easy</button></div></div></div>
    <div id="edit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex justify-center items-center p-4"><div class="bg-brand-secondary rounded-2xl shadow-2xl w-full max-w-md p-6"><h2 id="edit-modal-title" class="text-2xl font-bold mb-6"></h2><form id="edit-form"></form><div class="mt-6 flex justify-end space-x-4"><button id="edit-cancel-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="edit-save-btn" class="btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-2 px-4 rounded-lg">Save</button></div></div></div>

<script type="module">
    const App = {
        state: {}, timerInterval: null,
        
        getDefaultState() {
            return {
                points: 100, tasksPerDay: 1, activeTask: null, lastTaskDate: null,
                dailyTasksAssigned: 0, rewardsRedeemedToday: 0, lastPriceCheckDate: null,
                saleIsOn: false, rewardLog: [], soundInitialized: false,
                taskDurationHours: 2, compliance: 100, compliancePenalty: 20,
                skipPasses: 0, totalTasksCompleted: 0,
                currentStreak: 0, lastStreakDate: null,
                tasks: [
                    { id: 't1', name: 'Pushups', value: 10, unit: 'reps', points: 10, enabled: true, consecutiveSuccesses: 0, scheduledDay: 'any' },
                    { id: 't2', name: 'Pull ups', value: 5, unit: 'reps', points: 20, enabled: true, consecutiveSuccesses: 0, scheduledDay: 'any' },
                ],
                rewards: [ { id: 'r1', name: 'Eat Candy', points: 50 }, { id: 'r2', name: '30min Me Time', points: 100 }, ],
                forfeits: {
                    tasks: [ { id: 'ft1', name: 'Face the corner', enabled: true }, { id: 'ft2', name: 'Face the wall', enabled: true }, ],
                    positions: [ { id: 'fp1', name: 'Hands in air', enabled: true }, { id: 'fp2', name: 'Hands on hair', enabled: true }, ],
                    duration: 900,
                }
            };
        },

        saveState() { try { localStorage.setItem('taskmaster_state', JSON.stringify(this.state)); } catch (error) { console.error("FATAL: Could not save state!", error); } },
        loadState() {
            try {
                const s = localStorage.getItem('taskmaster_state');
                if (s) {
                    let loadedState = JSON.parse(s);
                    if(loadedState.tasks) {
                        loadedState.tasks.forEach(t => {
                            if (t.scheduledDay === undefined) t.scheduledDay = 'any';
                            if (t.consecutiveSuccesses === undefined) t.consecutiveSuccesses = 0;
                        });
                    }
                    this.state = { ...this.getDefaultState(), ...loadedState };
                } else { this.state = this.getDefaultState(); }
            } catch (error) {
                console.error("Error loading state, resetting to default:", error);
                localStorage.removeItem('taskmaster_state');
                this.state = this.getDefaultState();
            }
        },

        init() { this.loadState(); this.attachEventListeners(); if (!this.state.soundInitialized) { this.showModal('sound-modal'); } else { this.runStartupLogic(); } },
        runStartupLogic() { this.checkStreak(); this.checkDateAndReset(); this.checkAndAdjustPrices(); this.checkForNewTask(); this.render(); },
        
        attachEventListeners() {
            document.getElementById('enable-sound-btn').addEventListener('click', async () => { await Tone.start(); this.state.soundInitialized = true; this.saveState(); this.hideModal('sound-modal'); this.runStartupLogic(); });
            document.getElementById('manage-btn').addEventListener('click', () => this.showModal('manage-modal'));
            document.getElementById('shop-btn').addEventListener('click', () => { if (this.state.compliance <= 50) { this.showResult('Shop Privileges Revoked!', `Compliance is at ${this.state.compliance}%. Get it above 50% to regain access.`); } else { this.renderShopModal(true); this.showModal('shop-modal'); } });
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', e => this.hideModal(e.target.dataset.modal)));
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', e => this.switchTab(e.target)));
            document.getElementById('main-content').addEventListener('click', e => { if (e.target.id === 'complete-task-btn') this.completeTask(); if (e.target.id === 'skip-task-btn') this.skipTask(); if (e.target.id === 'complete-forfeit-btn') this.showModal('feedback-modal'); });
            document.getElementById('result-ok-btn').addEventListener('click', () => { this.hideModal('result-modal'); this.checkForNewTask(); this.render(); });
            document.querySelectorAll('.feedback-btn').forEach(btn => btn.addEventListener('click', e => this.handleForfeitFeedback(e.target.dataset.feedback)));
            document.getElementById('edit-cancel-btn').addEventListener('click', () => this.hideModal('edit-modal'));
            document.getElementById('edit-save-btn').addEventListener('click', () => this.handleSave());
            document.getElementById('shop-modal').addEventListener('click', e => { if (e.target.classList.contains('redeem-reward-btn')) this.redeemReward(e); });
            document.getElementById('log-toggle-btn').addEventListener('click', e => { const i = e.target.textContent.includes('History'); this.renderShopModal(!i); });
        },
        
        playNotificationSound() { if (this.state.soundInitialized) { const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease("C5", "8n"); } },

        checkDateAndReset() { const t=dayjs().format('YYYY-MM-DD');if(this.state.lastTaskDate!==t){this.state.lastTaskDate=t;this.state.dailyTasksAssigned=0;this.saveState();} },
        checkAndAdjustPrices() { const t=dayjs().format('YYYY-MM-DD');if(this.state.lastPriceCheckDate&&this.state.lastPriceCheckDate!==t){if(this.state.rewardsRedeemedToday>=3){this.state.rewards.forEach(r=>r.points=Math.round(r.points*1.05));this.state.saleIsOn=false;}else if(this.state.rewardsRedeemedToday===0){this.state.rewards.forEach(r=>r.points=Math.max(1,Math.round(r.points*0.95)));this.state.saleIsOn=true;}else{this.state.saleIsOn=false;}this.state.rewardsRedeemedToday=0;}this.state.lastPriceCheckDate=t;this.saveState(); },
        checkStreak() { if (!this.state.lastStreakDate) return; const today = dayjs().startOf('day'); const lastDate = dayjs(this.state.lastStreakDate).startOf('day'); if (today.diff(lastDate, 'day') > 1) { this.state.currentStreak = 0; } },
        checkForNewTask() { if (!this.state.activeTask && this.state.dailyTasksAssigned < this.state.tasksPerDay) { this.assignTask(); } },
        
        assignTask() {
            const today = dayjs().day();
            const scheduledTasks = this.state.tasks.filter(t => t.enabled && parseInt(t.scheduledDay) === today);
            const randomTasks = this.state.tasks.filter(t => t.enabled && t.scheduledDay === 'any');
            
            let taskToAssign = null;
            if (this.state.dailyTasksAssigned < scheduledTasks.length) { taskToAssign = scheduledTasks[this.state.dailyTasksAssigned]; } 
            else if (randomTasks.length > 0) { taskToAssign = randomTasks[Math.floor(Math.random() * randomTasks.length)]; }
            
            if (taskToAssign) {
                let nameString = (taskToAssign.unit === 'area') ? `${taskToAssign.name}` : `${taskToAssign.value} ${taskToAssign.unit} ${taskToAssign.name}`;
                this.state.activeTask = { id: taskToAssign.id, name: nameString, assignedAt: Date.now(), type: 'task', points: taskToAssign.points };
                this.state.dailyTasksAssigned++;
                this.playNotificationSound();
                this.saveState(); 
            }
        },

        completeTask() {
            clearInterval(this.timerInterval);
            const task = this.state.activeTask;
            const originalTask = this.state.tasks.find(t => t.id === task.id);
            let detailsMessage = '';
            if(originalTask) {
                originalTask.consecutiveSuccesses = (originalTask.consecutiveSuccesses || 0) + 1;
                if(originalTask.consecutiveSuccesses >= 3 && originalTask.unit !== 'area') {
                    const oldValue = originalTask.value;
                    originalTask.value = Math.ceil(oldValue * 1.1);
                    originalTask.consecutiveSuccesses = 0;
                    detailsMessage += `<p class="text-brand-success mt-2">✨ ${originalTask.name} leveled up! New goal: ${originalTask.value} ${originalTask.unit}.</p>`;
                }
            }
            const today = dayjs().format('YYYY-MM-DD');
            const yesterday = dayjs().subtract(1, 'day').format('YYYY-MM-DD');
            if (this.state.lastStreakDate !== today) {
                if (this.state.lastStreakDate === yesterday) { this.state.currentStreak++; } 
                else { this.state.currentStreak = 1; }
                this.state.lastStreakDate = today;
                detailsMessage += `<p class="text-yellow-400 mt-2">🔥 Daily Streak: ${this.state.currentStreak} day(s)!</p>`;
            }
            this.state.totalTasksCompleted++;
            if (this.state.totalTasksCompleted > 0 && this.state.totalTasksCompleted % 20 === 0) {
                this.state.skipPasses++;
                detailsMessage += `<p class="text-blue-400 mt-2">🎟️ You earned a Skip Pass!</p>`;
            }
            this.state.points += task.points;
            this.state.compliance = Math.min(100, this.state.compliance + 10);
            this.state.activeTask = null;
            this.saveState();
            this.showResult('Task Complete!', `You earned ${task.points} points. Compliance is now ${this.state.compliance}%.`, detailsMessage);
            this.render();
        },
        
        skipTask() { if (this.state.skipPasses > 0) { clearInterval(this.timerInterval); this.state.skipPasses--; this.state.activeTask = null; this.saveState(); this.showResult('Task Skipped', `You used a skip pass. You have ${this.state.skipPasses} remaining.`); this.render(); } },

        failTaskByTimer() {
            if (!this.state.activeTask || this.state.activeTask.type !== 'task') return;
            
            clearInterval(this.timerInterval);
            this.timerInterval = null;
            
            const failedTask = { ...this.state.activeTask };
            let detailsMessage = '';
            
            const originalTask = this.state.tasks.find(t => t.id === failedTask.id);
            if(originalTask) {
                originalTask.consecutiveSuccesses = 0;
                if (originalTask.unit !== 'area') {
                    const oldValue = originalTask.value;
                    originalTask.value = Math.max(1, Math.floor(oldValue * 0.9));
                    detailsMessage = `<p class="text-brand-danger mt-2">🔻 ${originalTask.name} difficulty reduced to ${originalTask.value} ${originalTask.unit}.</p>`;
                }
            }
            
            const newCompliance = Math.max(0, this.state.compliance - this.state.compliancePenalty);
            const newForfeit = this.calculateForfeit();
            
            this.state.activeTask = newForfeit;
            this.state.compliance = newCompliance;
            this.state.currentStreak = 0;
            
            this.saveState();
            this.render();
            
            if (newForfeit) { this.showResult("Time's Up!", `A forfeit has been assigned. Compliance is now ${this.state.compliance}%. Your streak is broken.`, detailsMessage); } 
            else { this.showResult('Forfeit Skipped', `Task failed, but no forfeits are enabled. Compliance is now ${this.state.compliance}%. Your streak is broken.`, detailsMessage); }
        },

        calculateForfeit() { const t=this.state.forfeits.tasks.filter(t=>t.enabled),p=this.state.forfeits.positions.filter(p=>p.enabled);if(t.length===0||p.length===0){return null;} const r=t[Math.floor(Math.random()*t.length)],o=p[Math.floor(Math.random()*p.length)];return{id:`f-${Date.now()}`,name:r.name,position:o.name,duration:this.state.forfeits.duration,assignedAt:Date.now(),type:'forfeit'}; },
        handleForfeitFeedback(f){const d=this.state.forfeits.duration;if(f==='easy'){this.state.forfeits.duration=Math.round(d*1.1);if(this.state.tasksPerDay<12)this.state.tasksPerDay++;}else if(f==='ok'){this.state.forfeits.duration=Math.round(d*1.05);}else if(f==='hard'){this.state.forfeits.duration=Math.max(60,Math.round(d*.9));if(this.state.tasksPerDay>1)this.state.tasksPerDay--;}this.state.activeTask=null;this.hideModal('feedback-modal');this.saveState();this.showResult('Forfeit Complete','Discipline administered. Get back to it.');this.render();},
        redeemReward(e){const{id:t}=e.target.dataset,r=this.state.rewards.find(r=>r.id===t);if(r&&this.state.points>=r.points){this.state.points-=r.points;this.state.rewardsRedeemedToday++;this.state.rewardLog.unshift({name:r.name,points:r.points,redeemedAt:Date.now()});this.saveState();this.render();this.renderShopModal(true);this.showResult('Reward Claimed!',`You redeemed "${r.name}" for ${r.points} points.`);}},
        
        render() { this.renderMainContent(); this.renderManagement(); this.renderHeader(); this.renderComplianceBar(); },
        
        renderHeader() { document.getElementById('points-display').textContent = this.state.points; const s = document.getElementById('streak-display'); if (this.state.currentStreak > 0) { s.innerHTML = `<p class="text-brand-subtle text-sm">Streak</p><p class="text-2xl font-bold text-yellow-400">🔥 ${this.state.currentStreak}</p>`; } else { s.innerHTML = ''; } },
        renderMainContent() {
            const mainContent = document.getElementById('main-content');
            if (this.state.activeTask && this.state.activeTask.type === 'task') { this.renderActiveTask(mainContent); } 
            else if (this.state.activeTask && this.state.activeTask.type === 'forfeit') { this.renderActiveForfeit(mainContent); } 
            else {
                 const enabledTasks = this.state.tasks.filter(t => t.enabled);
                 if (enabledTasks.length === 0) { mainContent.innerHTML = `<h2 class="text-2xl font-bold text-brand-warning mb-2">No Tasks Enabled</h2><p class="text-brand-subtle">Go to 'Manage' and add tasks to your roster.</p>`; } 
                 else { mainContent.innerHTML = `<h2 class="text-2xl font-bold text-brand-text mb-2">Awaiting Orders.</h2><p class="text-brand-subtle">Stand by for your next assignment.</p>`; }
            }
        },
        renderActiveTask(c){
            const t = this.state.activeTask; 
            const d = t.assignedAt + (this.state.taskDurationHours * 60 * 60 * 1000); 
            const skipButton = this.state.skipPasses > 0 ? `<button id="skip-task-btn" class="btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg">Skip Task (${this.state.skipPasses})</button>` : ''; 
            c.innerHTML=`<p class="text-brand-subtle mb-2">Your Orders:</p><h2 class="text-3xl font-bold text-brand-text mb-4">${t.name}</h2><div class="text-lg text-brand-warning mb-6" id="timer"></div><div class="flex justify-center space-x-4"><button id="complete-task-btn" class="btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-8 rounded-lg">Complete</button>${skipButton}</div>`; 
            const e=document.getElementById('timer'); 
            clearInterval(this.timerInterval); 
            this.timerInterval = setInterval(() => {
                const s = d - Date.now();
                if (s <= 0) {
                    clearInterval(this.timerInterval);
                    this.failTaskByTimer();
                } else {
                    const h=Math.floor(s/36e5),m=Math.floor(s%36e5/6e4),c=Math.floor(s%6e4/1e3);
                    if(e) e.textContent=`Time left: ${h}h ${m}m ${c}s`;
                }
            }, 1000);
        },
        renderActiveForfeit(c){const f=this.state.activeTask,d=dayjs.duration(f.duration,'seconds').format('m [minutes and] s [seconds]');c.innerHTML=`<p class="text-brand-subtle mb-2">Your Forfeit:</p><h2 class="text-3xl font-bold text-brand-danger mb-2">${f.name}</h2><p class="text-xl text-brand-subtle mb-2">Position: ${f.position}</p><p class="text-xl text-brand-warning mb-6">Duration: ${d}</p><button id="complete-forfeit-btn" class="btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-8 rounded-lg">Forfeit Completed</button>`;},
        renderComplianceBar() { const bar = document.getElementById('compliance-bar'); const text = document.getElementById('compliance-text'); if (bar && text) { bar.style.width = `${this.state.compliance}%`; text.textContent = `Compliance: ${this.state.compliance}%`; } },
        switchTab(e){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('tab-active'));e.classList.add('tab-active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));document.getElementById(`${e.dataset.tab}-tab`).classList.remove('hidden');this.renderManagement();},
        renderManagement(){const a=document.querySelector('#manage-modal .tab-active').dataset.tab;if(a==='tasks')this.renderList('tasks',this.state.tasks,['name','value','unit','points']);if(a==='forfeits')this.renderForfeitsTab();if(a==='settings')this.renderSettingsTab();},
        renderShopModal(s){const c=document.getElementById('shop-content'),t=document.getElementById('log-toggle-btn');if(s){const a=this.state.saleIsOn?`<div class="bg-green-500/20 border border-green-500 text-green-300 text-center p-3 rounded-lg mb-4">🔥 **REWARD SALE ON!** All prices are 5% off today! 🔥</div>`:'';const i=this.state.rewards.map(item=>{const n=this.state.points>=item.points;return` <div class="flex items-center justify-between p-3 rounded-lg bg-brand-primary mb-2 ${n?'':'opacity-50'}"> <div> <p class="font-semibold">${item.name}</p> <p class="text-sm font-bold ${this.state.saleIsOn?'text-green-400':'text-brand-accent'}">${item.points} Points</p> </div> <button class="btn redeem-reward-btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-1 px-3 rounded-md text-sm" data-id="${item.id}" ${n?'':'disabled'}>Redeem</button> </div>`}).join('');c.innerHTML=a+i;t.textContent='View Purchase History';}else{let l='<h3 class="text-lg font-bold mb-4">Purchase History</h3>';if(this.state.rewardLog.length===0){l+='<p class="text-brand-subtle">You haven\'t purchased any rewards yet.</p>';}else{l+=this.state.rewardLog.map(log=>` <div class="flex justify-between items-center p-2 bg-brand-primary rounded-md mb-2"> <div> <p class="font-semibold">${log.name}</p> <p class="text-xs text-brand-subtle">${dayjs(log.redeemedAt).fromNow()}</p> </div> <p class="font-bold text-brand-accent">${log.points}</p> </div>`).join('');}c.innerHTML=l;t.textContent='Back to Shop';}},
        renderList(t,i,f){const c=document.getElementById(`${t}-tab`),h=i.map(item=>`<div class="flex items-center justify-between p-3 rounded-lg bg-brand-primary mb-2"><div class="flex items-center"><label class="flex items-center cursor-pointer mr-4"><input type="checkbox" class="form-checkbox h-5 w-5 text-brand-accent bg-gray-800 border-gray-600 rounded focus:ring-brand-accent" data-type="${t}" data-id="${item.id}" ${item.enabled?'checked':''}></label><div><p class="font-semibold ${item.enabled?'':'line-through text-gray-500'}">${item.name}</p><p class="text-sm text-brand-subtle">${f.slice(1).map(k=>`${k.charAt(0).toUpperCase()+k.slice(1)}: ${item[k]}`).join(', ')}</p></div></div><div><button class="edit-item-btn text-brand-subtle hover:text-white mr-2" data-type="${t}" data-id="${item.id}">Edit</button><button class="delete-item-btn text-brand-danger hover:text-red-400" data-type="${t}" data-id="${item.id}">Delete</button></div></div>`).join('');c.innerHTML=`<div class="mb-6">${h}</div><button class="add-item-btn w-full btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-3 px-4 rounded-lg" data-type="${t}">Add New ${t.slice(0,-1)}</button>`;c.querySelectorAll('.form-checkbox').forEach(b=>b.addEventListener('change',e=>this.toggleEnable(e)));c.querySelectorAll('.delete-item-btn').forEach(b=>b.addEventListener('click',e=>this.deleteItem(e)));c.querySelectorAll('.add-item-btn').forEach(b=>b.addEventListener('click',e=>this.handleAddItem(e)));c.querySelectorAll('.edit-item-btn').forEach(b=>b.addEventListener('click',e=>this.handleEditItem(e)));},
        renderForfeitsTab(){const c=document.getElementById('forfeits-tab'),{tasks:t,positions:p}=this.state.forfeits,r=(s,l)=>l.map(i=>`<div class="flex items-center justify-between p-3 rounded-lg bg-brand-primary mb-2"><div class="flex items-center"><label class="flex items-center cursor-pointer mr-4"><input type="checkbox" class="form-checkbox h-5 w-5 text-brand-accent bg-gray-800 border-gray-600 rounded focus:ring-brand-accent" data-type="forfeits" data-subtype="${s}" data-id="${i.id}" ${i.enabled?'checked':''}></label><p class="font-semibold ${i.enabled?'':'line-through text-gray-500'}">${i.name}</p></div><div><button class="delete-item-btn text-brand-danger hover:text-red-400" data-type="forfeits" data-subtype="${s}" data-id="${i.id}">Delete</button></div></div>`).join('');c.innerHTML=`<div class="mb-4"><h3 class="text-lg font-semibold mb-2">Forfeit Tasks</h3>${r('tasks',t)}<button class="add-item-btn w-full btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-2 px-4 rounded-lg mt-2" data-type="forfeits" data-subtype="tasks">Add New Task</button></div><div class="mb-4"><h3 class="text-lg font-semibold mb-2">Forfeit Positions</h3>${r('positions',p)}<button class="add-item-btn w-full btn bg-brand-accent hover:bg-brand-accent-hover text-white font-bold py-2 px-4 rounded-lg mt-2" data-type="forfeits" data-subtype="positions">Add New Position</button></div>`;c.querySelectorAll('.form-checkbox').forEach(b=>b.addEventListener('change',e=>this.toggleEnable(e)));c.querySelectorAll('.delete-item-btn').forEach(b=>b.addEventListener('click',e=>this.deleteItem(e)));c.querySelectorAll('.add-item-btn').forEach(b=>b.addEventListener('click',e=>this.handleAddItem(e)));},
        renderSettingsTab(){const c=document.getElementById('settings-tab');c.innerHTML=`<div class="bg-brand-primary p-4 rounded-lg"><label for="tasks-per-day" class="block text-lg font-semibold mb-2">Tasks Per Day</label><input type="number" id="tasks-per-day" min="1" max="12" value="${this.state.tasksPerDay}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"><p class="text-sm text-brand-subtle mt-2">Set how many tasks you want to be assigned each day (1-12).</p></div> <div class="bg-brand-primary p-4 rounded-lg mt-4"><label for="task-duration" class="block text-lg font-semibold mb-2">Task Duration (hours)</label><input type="number" id="task-duration" min="1" max="24" value="${this.state.taskDurationHours}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"><p class="text-sm text-brand-subtle mt-2">Set how long you have to complete a task.</p></div> <div class="bg-brand-primary p-4 rounded-lg mt-4"><label for="forfeit-duration" class="block text-lg font-semibold mb-2">Base Forfeit Duration (minutes)</label><input type="number" id="forfeit-duration" min="1" value="${this.state.forfeits.duration/60}" class="w-full bg-brand-secondary text-white p-2 rounded-md border border-gray-600"></div> <div class="mt-6"><button id="save-settings-btn" class="w-full btn bg-brand-success hover:bg-green-500 text-white font-bold py-3 px-4 rounded-lg">Save Settings</button></div>`;document.getElementById('save-settings-btn').addEventListener('click',()=>{this.state.tasksPerDay=parseInt(document.getElementById('tasks-per-day').value,10);this.state.taskDurationHours=parseInt(document.getElementById('task-duration').value,10);this.state.forfeits.duration=parseInt(document.getElementById('forfeit-duration').value,10)*60;this.saveState();this.showResult("Settings Saved","Your new settings have been applied.");});},
        toggleEnable(e){const{type:t,id:i,subtype:s}=e.target.dataset;let a;if(t==='forfeits'){a=this.state.forfeits[s].find(item=>item.id===i);}else{a=this.state[t].find(item=>item.id===i);}if(a){a.enabled=e.target.checked;this.saveState();this.renderManagement();}},
        deleteItem(e){const{type:t,id:i,subtype:s}=e.target.closest('button').dataset;if(confirm('Are you sure you want to delete this item?')){if(t==='forfeits'){this.state.forfeits[s]=this.state.forfeits[s].filter(item=>item.id!==i);}else{this.state[t]=this.state[t].filter(item=>item.id!==i);}this.saveState();this.renderManagement();}},
        handleAddItem(e){const{type:t,subtype:s}=e.target.dataset;this.openEditModal(t,null,s);},
        handleEditItem(e){const{type:t,id:i}=e.target.closest('button').dataset;this.openEditModal(t,i);},
        openEditModal(t,i,s=null){const n=i===null;let a=n?{}:t==='forfeits'?this.state.forfeits[s].find(item=>item.id===i):this.state[t].find(item=>item.id===i);const o=document.getElementById('edit-form');let d='';let l=`${n?'Add':'Edit'} ${s||t.slice(0,-1)}`;const f={tasks:{name:'text',value:'number',unit:'text',points:'number', scheduledDay:'select'},forfeits:{name:'text'}};const c=f[t];for(const[k,p]of Object.entries(c)){d+=`<div class="mb-4"><label class="block text-brand-subtle text-sm font-bold mb-2" for="${k}">${k.charAt(0).toUpperCase()+k.slice(1)}</label>`;if(p==='select'){const days=['Any Day (Random)','Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];d+=`<select class="shadow appearance-none border rounded w-full py-2 px-3 bg-brand-primary border-gray-600 text-white" id="${k}">${days.map((day,idx)=>`<option value="${idx===0?'any':idx-1}" ${ (a[k] === (idx === 0 ? 'any' : (idx-1).toString())) ? 'selected':''}>${day}</option>`).join('')}</select>`;}else{d+=`<input class="shadow appearance-none border rounded w-full py-2 px-3 bg-brand-primary border-gray-600 text-white leading-tight focus:outline-none focus:shadow-outline" id="${k}" type="${p}" placeholder="${k}" value="${a[k]||''}">`;}d+='</div>';}o.innerHTML=d;document.getElementById('edit-modal-title').textContent=l;o.dataset.type=t;o.dataset.id=i;if(s)o.dataset.subtype=s;else delete o.dataset.subtype;this.showModal('edit-modal');},
        handleSave(){const f=document.getElementById('edit-form'),{type:t,id:i,subtype:s}=f.dataset,n=i==='null';let a=n?{id:`${t.charAt(0)}${Date.now()}`,enabled:true,consecutiveSuccesses:0}:{};const d=f.querySelectorAll('input, select');d.forEach(field=>{if(field.type==='number'){a[field.id]=parseInt(field.value,10)||0;}else{a[field.id]=field.value;}});if(n){if(t==='forfeits'){this.state.forfeits[s].push(a);}else{this.state[t].push(a);}}else{let c=t==='forfeits'?this.state.forfeits[s]:this.state[t];const e=c.findIndex(item=>item.id===i);if(e>-1){c[e]={...c[e],...a};}}this.saveState();this.renderManagement();this.hideModal('edit-modal');},

        showModal(id){document.getElementById(id).classList.remove('hidden');}, hideModal(id){document.getElementById(id).classList.add('hidden');},
        showResult(t,m,d=''){document.getElementById('result-title').textContent=t;document.getElementById('result-message').textContent=m;document.getElementById('result-details').innerHTML=d;this.showModal('result-modal');},
    };

    document.addEventListener('DOMContentLoaded', () => { App.init(); });
</script>

</body>
</html>

